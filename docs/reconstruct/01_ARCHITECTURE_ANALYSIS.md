# é¡¹ç›®æ¶æ„æ·±åº¦åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2025-10-14  
**é¡¹ç›®**: IgnisBenchmark - QAç”Ÿæˆç³»ç»Ÿ  
**å½“å‰ç‰ˆæœ¬**: Milestone 1 å®Œæˆ

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### å½“å‰çŠ¶æ€
âœ… **å·²å®Œæˆ**: Milestone 1 (å•æ–‡çŒ®20é¢˜ç”Ÿæˆ)  
ğŸ”„ **è¿›è¡Œä¸­**: å‘Milestone 2 (100æ–‡çŒ®æ‰¹é‡ç”Ÿæˆ) æ¼”è¿›  
âš ï¸ **é—®é¢˜**: æ¶æ„å­˜åœ¨è€¦åˆã€å¹¶å‘æ··ä¹±ã€æ‰©å±•æ€§ä¸è¶³

### æ ¸å¿ƒé—®é¢˜è¯†åˆ«

| é—®é¢˜åŸŸ | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ |
|--------|----------|----------|
| **æ¨¡å—è€¦åˆåº¦é«˜** | ğŸ”´ é«˜ | ç»´æŠ¤å›°éš¾ã€æµ‹è¯•å›°éš¾ |
| **å¹¶å‘æ§åˆ¶æ··ä¹±** | ğŸ”´ é«˜ | æ€§èƒ½ç“¶é¢ˆã€èµ„æºæµªè´¹ |
| **é…ç½®ä¸ä¸€è‡´** | ğŸŸ¡ ä¸­ | ä»£ç å¯è¯»æ€§å·®ã€æ˜“å‡ºé”™ |
| **é”™è¯¯å¤„ç†åˆ†æ•£** | ğŸŸ¡ ä¸­ | è°ƒè¯•å›°éš¾ã€æ—¥å¿—æ··ä¹± |
| **å¯æµ‹è¯•æ€§å·®** | ğŸŸ¡ ä¸­ | å•å…ƒæµ‹è¯•ç¼ºå¤±ã€é›†æˆæµ‹è¯•å›°éš¾ |

---

## ğŸ—ï¸ å½“å‰æ¶æ„åˆ†æ

### 1. ç»„ä»¶æ¸…å•

```
distillation_generation/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ question_generator.py      # é¢˜ç›®ç”Ÿæˆ [250è¡Œ]
â”‚   â”œâ”€â”€ answering_module.py        # æ¨¡å‹è§£é¢˜ [236è¡Œ]
â”‚   â”œâ”€â”€ grading_module.py          # è‡ªåŠ¨åˆ¤é¢˜ [210è¡Œ]
â”‚   â”œâ”€â”€ model_manager.py           # æ¨¡å‹å›é€€ [375è¡Œ] âš ï¸æœªä½¿ç”¨
â”‚   â”œâ”€â”€ data_persistence.py        # æ•°æ®æŒä¹…åŒ– [211è¡Œ]
â”‚   â”œâ”€â”€ prompt_manager.py          # Promptç®¡ç†
â”‚   â”œâ”€â”€ models.py                  # æ•°æ®æ¨¡å‹ [148è¡Œ]
â”‚   â”œâ”€â”€ token_tracker.py           # Tokenç»Ÿè®¡
â”‚   â””â”€â”€ utils.py                   # å·¥å…·å‡½æ•°
â”œâ”€â”€ main.py                        # ä¸»æµç¨‹ [221è¡Œ]
â””â”€â”€ milestone1_generator.py        # M1è„šæœ¬ [450è¡Œ]
```

### 2. ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    A[main.py] --> B[QuestionGenerator]
    A --> C[AnsweringModule]
    A --> D[GradingModule]
    A --> E[DataPersistence]
    
    B --> F[PromptManager]
    C --> F
    D --> F
    
    B --> G[ModelManager] 
    G -.æœªé›†æˆ.-> B
    
    B --> H[litellm]
    C --> H
    D --> H
    
    E --> I[models.py]
    B --> I
    C --> I
    D --> I
    
    style G fill:#f99,stroke:#f66
    style H fill:#9cf,stroke:#69f
```

### 3. å…³é”®é—®é¢˜å‰–æ

#### é—®é¢˜1: æ¨¡å‹è°ƒç”¨é€»è¾‘é‡å¤ ğŸ”´

**ç°çŠ¶**:
- `QuestionGenerator`: å†…åµŒæ¨¡å‹å›é€€é€»è¾‘ (120è¡Œä»£ç )
- `AnsweringModule`: å†…åµŒé‡è¯•é€»è¾‘ (80è¡Œä»£ç )
- `GradingModule`: å†…åµŒé‡è¯•é€»è¾‘ (70è¡Œä»£ç )
- `ModelManager`: å®Œæ•´å®ç°ä½†**æœªè¢«ä½¿ç”¨**

**ä»£ç ç¤ºä¾‹** (question_generator.py L104-180):
```python
# æ¯ä¸ªæ¨¡å—éƒ½é‡å¤å®ç°äº†æ¨¡å‹å›é€€
model_fallbacks = []
if config and 'generation_models' in config:
    for m in config['generation_models']:
        # ... 50è¡Œé…ç½®è§£æä»£ç 
for attempt in range(3):
    for model_index, m in enumerate(model_fallbacks):
        try:
            response = completion(...)
            # ... é‡è¯•é€»è¾‘
```

**é—®é¢˜**:
- ä»£ç é‡å¤ç‡ > 60%
- é€»è¾‘ä¸ä¸€è‡´ (å„æ¨¡å—é‡è¯•æ¬¡æ•°ä¸åŒ)
- éš¾ä»¥ç»Ÿä¸€è°ƒä¼˜

#### é—®é¢˜2: å¹¶å‘é…ç½®æ··ä¹± ğŸ”´

**config.yaml çš„çŸ›ç›¾**:
```yaml
rounds_concurrency: 3           # è½®æ¬¡é—´å¹¶å‘
round_internal_concurrency: 5   # è½®æ¬¡å†…å¹¶å‘
max_concurrent_requests: 10     # æœ€å¤§è¯·æ±‚æ•°

# æ³¨é‡Šå†™é“ï¼š
# è¿™é‡Œæœ‰é—®é¢˜ï¼ï¼ï¼ï¼ï¼é¢˜ç›®ç”Ÿæˆã€è§£ç­”å’Œåˆ¤é¢˜çš„å¹¶å‘æ•°åº”å½“æ˜¯ç‹¬ç«‹çš„ï¼
```

**å®é™…æ‰§è¡Œ**:
- `QuestionGenerator`: **ä¸²è¡Œ**ç”Ÿæˆ (1ä¸ªæ¨¡å‹è°ƒç”¨/batch)
- `AnsweringModule`: ä½¿ç”¨`ThreadPoolExecutor(max_workers=5)` å¹¶å‘è§£é¢˜
- `GradingModule`: **ä¸²è¡Œ**åˆ¤é¢˜
- `main.py`: **ä¸²è¡Œ**è°ƒç”¨ä¸‰ä¸ªæ¨¡å—

**é—®é¢˜**:
- é…ç½®é¡¹ä¸å®é™…è¡Œä¸ºä¸åŒ¹é…
- å¹¶å‘å±‚æ¬¡ä¸æ¸…æ™° (è½®æ¬¡çº§ vs é¢˜ç›®çº§ vs è¯·æ±‚çº§)
- èµ„æºåˆ©ç”¨ç‡ä½

#### é—®é¢˜3: é…ç½®åˆå§‹åŒ–ä¸ä¸€è‡´ ğŸŸ¡

**ä¸‰ç§åˆå§‹åŒ–æ¨¡å¼**:

1. **é…ç½®å­—å…¸æ¨¡å¼** (æ–°)
```python
generator = QuestionGenerator(config_dict)
```

2. **å‚æ•°æ¨¡å¼** (æ—§)
```python
generator = QuestionGenerator("gemini/...", batch_size=10)
```

3. **æ··åˆæ¨¡å¼** (å…¼å®¹å±‚)
```python
def __init__(self, config_or_model_name, batch_size=None, ...):
    if isinstance(config_or_model_name, dict):
        # é…ç½®å­—å…¸
    else:
        # å•ç‹¬å‚æ•°
```

**é—®é¢˜**:
- ä»£ç å†—é•¿ (æ¯ä¸ªæ¨¡å—50è¡Œåˆå§‹åŒ–ä»£ç )
- ç±»å‹ä¸å®‰å…¨
- IDEæ— æ³•è‡ªåŠ¨è¡¥å…¨

#### é—®é¢˜4: æ•°æ®æµæ··ä¹± ğŸŸ¡

**å½“å‰æ•°æ®æµ**:
```
main.py:
  1. ä»benchmark_bankæŠ½å–Few-shot
  2. ç”Ÿæˆé¢˜ç›® â†’ List[QuestionUnit]
  3. è§£é¢˜ â†’ ä¿®æ”¹QuestionUnit.candidate_answer
  4. åˆ¤é¢˜ â†’ è¿”å›GradingResult
  5. æ ¹æ®ç»“æœåˆ†æµ:
     - é”™é¢˜ â†’ save_to_benchmark()
     - æ­£ç¡® â†’ save_to_validation()
```

**é—®é¢˜**:
- çŠ¶æ€å¯å˜ (QuestionUnitè¢«å¤šæ¬¡ä¿®æ”¹)
- ä¸­é—´çŠ¶æ€æ— è¿½è¸ª
- æ— æ³•æ¢å¤/é‡è¯•å•ä¸ªæ­¥éª¤

#### é—®é¢˜5: é”™è¯¯å¤„ç†ç¢ç‰‡åŒ– ğŸŸ¡

**å„æ¨¡å—ç‹¬ç«‹å¤„ç†é”™è¯¯**:
```python
# question_generator.py
try:
    response = completion(...)
except Exception as e:
    logger.warning(f"æ¨¡å‹å¤±è´¥: {e}")
    continue  # é™é»˜é‡è¯•

# answering_module.py
except Exception as e:
    logger.error(f"è§£é¢˜å¤±è´¥: {e}")
    return "[ERROR] ..."  # è¿”å›é”™è¯¯å­—ç¬¦ä¸²

# grading_module.py
except Exception as e:
    if error_callback:
        error_callback(question, ...)  # å›è°ƒå‡½æ•°
```

**é—®é¢˜**:
- é”™è¯¯å¤„ç†æ–¹å¼ä¸ç»Ÿä¸€
- éš¾ä»¥è¿½è¸ªå¤±è´¥åŸå› 
- é‡è¯•ç­–ç•¥ä¸ä¸€è‡´

---

## ğŸ“Š æ€§èƒ½ç“¶é¢ˆåˆ†æ

### Milestone 1 å®æµ‹æ•°æ®

| é˜¶æ®µ | è€—æ—¶ | ç“¶é¢ˆ |
|------|------|------|
| **è®ºæ–‡åŠ è½½** | <1s | âœ… æ—  |
| **é¢˜ç›®ç”Ÿæˆ** | ~60s | ğŸ”´ **å•æ¬¡LLMè°ƒç”¨** (20é¢˜ä¸€æ¬¡æ€§ç”Ÿæˆ) |
| **å…ƒæ•°æ®åŒ…è£…** | <1s | âœ… æ—  |
| **ä¿å­˜æ–‡ä»¶** | <1s | âœ… æ—  |
| **ç”ŸæˆæŠ¥å‘Š** | <1s | âœ… æ—  |
| **æ€»è®¡** | ~16åˆ†é’Ÿ | ğŸ”´ **æ¨¡å‹å›é€€é‡è¯•** (Geminiå¤±è´¥2æ¬¡) |

### Milestone 2 é¢„æµ‹ (100ç¯‡è®ºæ–‡)

**å‡è®¾**:
- æ¯ç¯‡è®ºæ–‡ç”Ÿæˆ20é¢˜
- å¹³å‡æˆåŠŸç‡: 70% (ç¬¬ä¸€æ¬¡æˆåŠŸ)
- å¹³å‡ç”Ÿæˆæ—¶é—´: 60s/ç¯‡

**ä¸²è¡Œæ‰§è¡Œ**:
```
æ€»æ—¶é—´ = 100ç¯‡ Ã— 60s = 6000s â‰ˆ 100åˆ†é’Ÿ
```

**å¹¶è¡Œæ‰§è¡Œ (3å¹¶å‘)**:
```
æ€»æ—¶é—´ = 100ç¯‡ / 3 Ã— 60s â‰ˆ 33åˆ†é’Ÿ
```

**ç“¶é¢ˆ**:
1. LLM APIé€Ÿç‡é™åˆ¶
2. Tokené…é¢æ¶ˆè€—
3. ç½‘ç»œè¶…æ—¶é‡è¯•

---

## ğŸ¯ æ¶æ„æ”¹è¿›ç›®æ ‡

### 1. æ¨¡å—åŒ–åŸåˆ™

```
Single Responsibility Principle (SRP)
â”œâ”€ ModelClient:        åªè´Ÿè´£è°ƒç”¨LLM API
â”œâ”€ RetryManager:       åªè´Ÿè´£é‡è¯•é€»è¾‘
â”œâ”€ ConcurrencyManager: åªè´Ÿè´£å¹¶å‘æ§åˆ¶
â”œâ”€ QuestionGenerator:  åªè´Ÿè´£æ„å»ºPrompt
â””â”€ DataRepository:     åªè´Ÿè´£æ•°æ®å­˜å‚¨
```

### 2. å¯æ’æ‹”è®¾è®¡

```python
# ç­–ç•¥æ¨¡å¼
class GenerationStrategy(Protocol):
    def generate(self, paper: Paper) -> List[Question]:
        ...

class SinglePaperStrategy(GenerationStrategy): ...
class BatchPaperStrategy(GenerationStrategy): ...

# ä¾èµ–æ³¨å…¥
pipeline = Pipeline(
    generator=GenerationStrategy,
    answerer=AnsweringStrategy,
    grader=GradingStrategy,
    storage=StorageBackend
)
```

### 3. å¹¶å‘åˆ†å±‚

```
Level 1: è®ºæ–‡çº§å¹¶å‘ (æ‰¹æ¬¡å¤„ç†)
    â”œâ”€ 3-5ç¯‡è®ºæ–‡åŒæ—¶å¤„ç†
    â”‚
    â”œâ”€ Level 2: é¢˜ç›®çº§å¹¶å‘ (å•æ‰¹æ¬¡å†…)
    â”‚   â”œâ”€ ç”Ÿæˆ: 1ä¸ªLLMè°ƒç”¨ â†’ 20é¢˜
    â”‚   â”œâ”€ è§£é¢˜: 20é¢˜ Ã— 5å¹¶å‘
    â”‚   â””â”€ åˆ¤é¢˜: 20é¢˜ Ã— 3å¹¶å‘
    â”‚
    â””â”€ Level 3: è¯·æ±‚çº§å¹¶å‘ (åº•å±‚API)
        â””â”€ å…±äº«ä¿¡å·é‡æ§åˆ¶æ€»è¯·æ±‚æ•°
```

### 4. é…ç½®é©±åŠ¨

```yaml
# æ¸…æ™°çš„é…ç½®å±‚æ¬¡
generation:
  strategy: "batch"
  concurrency: 3
  models:
    - name: "gemini-2.5-flash"
      priority: 1
      retry: 2

answering:
  concurrency: 5
  models: [...]

grading:
  concurrency: 3
  models: [...]
```

### 5. å¯è§‚æµ‹æ€§

```python
# ç»Ÿä¸€ç›‘æ§
from observability import MetricsCollector

metrics = MetricsCollector()
with metrics.track("question_generation"):
    questions = generator.generate(...)
    
# è¾“å‡º:
# - æˆåŠŸç‡
# - å¹³å‡å»¶è¿Ÿ
# - Tokenæ¶ˆè€—
# - æ¨¡å‹åˆ‡æ¢æ¬¡æ•°
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ä¼˜å…ˆçº§ P0 (å¿…é¡»ç«‹å³è§£å†³)
1. âœ… **åˆ›å»ºæ¶æ„åˆ†ææ–‡æ¡£** (æœ¬æ–‡æ¡£)
2. ğŸ“ **è®¾è®¡æ–°æ¶æ„æ–¹æ¡ˆ** â†’ `02_NEW_ARCHITECTURE_DESIGN.md`
3. ğŸ“ **åˆ¶å®šè¿ç§»è®¡åˆ’** â†’ `03_MIGRATION_ROADMAP.md`

### ä¼˜å…ˆçº§ P1 (Milestone 2å‰å®Œæˆ)
4. ğŸ”§ **å®ç°ç»Ÿä¸€ModelClient**
5. ğŸ”§ **å®ç°ConcurrencyManager**
6. ğŸ”§ **é‡æ„ä¸‰å¤§æ¨¡å—**

### ä¼˜å…ˆçº§ P2 (å¯å»¶å)
7. ğŸ§ª **è¡¥å……å•å…ƒæµ‹è¯•**
8. ğŸ“Š **æ·»åŠ æ€§èƒ½ç›‘æ§**
9. ğŸ“š **å®Œå–„æ–‡æ¡£**

---

## ğŸ“Œ å»ºè®®

### å¯¹äºå½“å‰çŠ¶æ€
- âœ… **Milestone 1ä»£ç å¯ä»¥ä¿æŒä¸åŠ¨** - ä½œä¸ºåŠŸèƒ½éªŒè¯å‚è€ƒ
- âš ï¸ **ä¸è¦åœ¨ç°æœ‰main.pyä¸Šç»§ç»­å¼€å‘** - æŠ€æœ¯å€ºä¼šçˆ†ç‚¸
- ğŸ¯ **ä½¿ç”¨Milestone 1çš„æˆæœ** - å¤ç”¨Promptã€æ•°æ®æ¨¡å‹

### å¯¹äºMilestone 2
- ğŸ—ï¸ **ä»é›¶é‡æ„ä¸»æµç¨‹** - åŸºäºæ–°æ¶æ„
- ğŸ”Œ **ä¿æŒæ¥å£å…¼å®¹** - å¤ç”¨ç°æœ‰æ¨¡å—ä½œä¸ºé€‚é…å™¨
- ğŸ“¦ **æ¸è¿›å¼è¿ç§»** - å…ˆé‡æ„è°ƒç”¨å±‚ï¼Œå†é‡æ„å®ç°

### å¯¹äºé•¿æœŸ
- ğŸ“ **æŠ•èµ„å¯æµ‹è¯•æ€§** - ç¼–å†™å•å…ƒæµ‹è¯•
- ğŸ“Š **æŠ•èµ„å¯è§‚æµ‹æ€§** - æ·»åŠ è¯¦ç»†æ—¥å¿—
- ğŸ” **æŠ•èµ„é²æ£’æ€§** - å®Œå–„é”™è¯¯å¤„ç†

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ–°æ¶æ„è®¾è®¡](./02_NEW_ARCHITECTURE_DESIGN.md) - è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ
- [è¿ç§»è·¯çº¿å›¾](./03_MIGRATION_ROADMAP.md) - åˆ†æ­¥å®æ–½è®¡åˆ’
- [APIè®¾è®¡æ–‡æ¡£](./04_API_DESIGN.md) - æ¥å£å®šä¹‰
- [å¹¶å‘æ§åˆ¶æ–¹æ¡ˆ](./05_CONCURRENCY_DESIGN.md) - å¹¶å‘æ¶æ„

---

**å®¡é˜…è€…**: AIæ¶æ„å¸ˆ  
**çŠ¶æ€**: å¾…å®¡æ ¸ â†’ ä¸‹ä¸€æ­¥: è®¾è®¡æ–°æ¶æ„
